"use strict";
document.addEventListener("DOMContentLoaded", function () {
  // Функция форматирования номера телефона
  function formatPhoneNumber(input, country) {
    var formattedNumber,
      numbers = input.value.replace(/\D/g, "");
    formattedNumber =
      "ru" === country
        ? "000 000 00 00"
        : intlTelInputUtils
            .getExampleNumber(
              country,
              !0,
              intlTelInputUtils.numberFormat.INTERNATIONAL
            )
            .replace(/[0-9]/g, "0")
            .replace(/^\+/, "");
    for (
      var result = "", numberIndex = 0, formatIndex = 0;
      formatIndex < formattedNumber.length && numberIndex < numbers.length;
      formatIndex++
    )
      "0" === formattedNumber[formatIndex]
        ? (result += numbers[numberIndex++])
        : (result += formattedNumber[formatIndex]);
    input.value = result;
  }

  // Получаем элементы формы
  var form = document.getElementById("autoRegForm"),
    phoneInput = document.getElementById("phone-number"),
    phoneHidden = document.getElementById("phone"),
    eyeIcon = document.getElementById("eye"),
    passwordInput = document.getElementById("password-input"),
    emailInput = document.getElementById("email-input");

  // Инициализация маски телефона
  var phoneMask = window.intlTelInput(phoneInput, {
    formatOnDisplay: true,
    autoPlaceholder: "aggressive",
    initialCountry: "RU",
    preferredCountries: ["RU"],
    separateDialCode: true,
    nationalMode: false,
    utilsScript:
      "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js",
    dropdownContainer: document.body,
    customContainer: "w-full",
    customPlaceholder: function (
      selectedCountryPlaceholder,
      selectedCountryData
    ) {
      return "e.g. " + selectedCountryPlaceholder;
    },
  });

  // Обработчики событий для телефона
  phoneInput.addEventListener("countrychange", function () {
    var country = phoneMask.getSelectedCountryData().iso2;
    formatPhoneNumber(phoneInput, country);
  });

  phoneInput.addEventListener("input", function () {
    var country = phoneMask.getSelectedCountryData().iso2;
    formatPhoneNumber(phoneInput, country);
  });

  // Функция показа ошибки
  function showError(input, message) {
    input.nextElementSibling.innerText = message;
    input.style.borderColor = "#DE2108";
  }

  // Функция валидации пароля
  function validatePassword() {
    var password = passwordInput.value,
      email = emailInput.value;

    if (password.length < 4) {
      showError(passwordInput, "Пароль должен содержать не менее 4 символов");
      return false;
    }

    if (
      !/^(?=.*[A-Za-z])(?=.*[\d!@#$%^&*()_+{}\[\]:;<>,.?~\/\\\-]).{4,}$/.test(
        password
      )
    ) {
      showError(
        passwordInput,
        "Пароль должен содержать буквы, цифры или специальные символы"
      );
      return false;
    }

    if (email && password.toLowerCase().includes(email.toLowerCase())) {
      showError(
        passwordInput,
        "Пароль не может содержать ваш адрес электронной почты"
      );
      return false;
    }

    passwordInput.nextElementSibling.innerText = "";
    passwordInput.style.borderColor = "rgba(255, 255, 255, 0.42)";
    return true;
  }

  // Переключение видимости пароля
  eyeIcon.addEventListener("click", function () {
    if (passwordInput.type === "password") {
      passwordInput.type = "text";
      eyeIcon.classList.add("is-active");
    } else {
      passwordInput.type = "password";
      eyeIcon.classList.remove("is-active");
    }
  });

  // Валидация при вводе пароля
  passwordInput.addEventListener("input", validatePassword);

  // Обработчик отправки формы
  if (form) {
    form.addEventListener("submit", function (e) {
      e.preventDefault();

      var isPhoneValid = phoneMask.isValidNumber(),
        isPasswordValid = validatePassword();

      if (isPhoneValid && isPasswordValid) {
        var phoneNumber = phoneMask.getNumber(
          intlTelInputUtils.numberFormat.E164
        );
        phoneHidden.value = phoneNumber;

        // Заглушка вместо отправки формы
        alert("Форма успешно отправлена!");
        form.reset();
      } else if (!isPhoneValid) {
        alert("Введите действительный номер мобильного телефона");
      }
    });
  }
});
("use strict");
